<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.itwillbs.mappers.instructMapper">
	
	<resultMap type="map" id="lineMap">
		<result property="lineId" column="lineId"/>
		<result property="lineCode" column="lineCode" />
		<result property="lineName" column="lineName" />
		<result property="proCode" column="proCode" />
		<result property="linePlace" column="linePlace" />
		<result property="useChoice" column="useChoice" />
	</resultMap>
	
	<resultMap type="map" id="itemMap">
		<result property="itemNum" column="itemNum" />
		<result property="itemName" column="itemName" />
		<result property="invntUnit" column="itemUnit" />
	</resultMap>
	
	<resultMap type="map" id="clntMap">
		<result property="clientName" column="clientName" />
	</resultMap>
	
	<resultMap type="map" id="ordMngMap">
		<result property="orderNum" column="orderNum" />
	</resultMap>
	
	<resultMap type="map" id="userMap">
		<result property="name" column="name" />
	</resultMap>
	
 	<resultMap type="map" id="instrMap">
 		<result property="instrId" column="instrId"/>
		<result property="workNum" column="workNum"/>
		<result property="workDate" column="workDate"/>
		<result property="workSts" column="workSts"/>
		<result property="workQty" column="workQty"/>
		<result property="insertDate" column="insertDate"/>
		<result property="insertId" column="insertId"/>
		<collection property="lineDTO" resultMap="lineMap" />
		<collection property="itemDTO" resultMap="itemMap" />
		<collection property="clntDTO" resultMap="clntMap" />
		<collection property="orderMngDTO" resultMap="ordMngMap" />
		<collection property="userDTO" resultMap="userMap" />
	</resultMap>
	
	<!-- instructList 메인 전체 select 구문 -->
	<select id="instrList" resultMap="instrMap">
		<include refid="List" />
		ORDER BY insertDate DESC
		LIMIT #{startRow} , #{pageSize}
	</select>
	
	<!-- instructList 조회 select 구문 -->
	<select id="instrSearch" resultMap="instrMap">
		<include refid="List" />
		<include refid="Search" />
		ORDER BY insertDate DESC
		LIMIT #{startRow}, #{pageSize}
	</select>
	
	<!-- 작업지시 전체 목록 개수 -->
	<select id="instrCount" resultType="java.lang.Integer">
		SELECT COUNT(*) FROM work_instr
	</select>
	
	<!-- 작업지시 조회 목록 개수 -->
	<select id="instrSearchCount" resultType="java.lang.Integer">
		<include refid="SearchCount" />
		<include refid="Search" />
	</select>
	
	<sql id="List">
		SELECT work.instr_id as instrId, work.work_num as workNum, clnt.clnt_nm as clientName, omng.ord_num as orderNum, 
		   work.work_dt as workDate, work.work_sts as workSts,
		   item.item_num as itemNum, item.item_nm as itemName, item.invnt_unit as itemUnit, 
		   line.line_cd as lineCode, line.line_nm as lineName, line.pro_cd as proCode, 
		   work.work_qty as workQty, work.insert_dt as insertDate, user.name
		FROM work_instr work JOIN order_mng omng ON work.ord_id = omng.ord_id
		JOIN order_info oinfo ON work.ord_info_id = oinfo.ord_info_id
		JOIN item item ON item.item_id = oinfo.item_id
		JOIN client clnt ON clnt.clnt_id = omng.clnt_id
		JOIN line line ON work.line_id = line.line_id
		JOIN user user ON work.insert_id = user.id
	</sql>
	
	<sql id="Search">
		WHERE line.line_cd LIKE CONCAT('%', #{lineName}, '%')
		<if test="startDate != '' and endDate != ''">
			AND work_dt BETWEEN	#{startDate} and #{endDate}
		</if>
		<if test="startDate == '' and endDate == ''">
		</if>
		<if test="startDate != ''">
			AND work_dt &gt;= #{startDate}
		</if>
		<if test="endDate != ''">
			AND work_dt &lt;= #{endDate}
		</if>
		<choose>
			<when test="(workSts1=='' and workSts2=='' and workSts3=='') or (workSts1==null and workSts2==null and workSts3==null)">
			</when>
			<otherwise>
				AND (work_sts = #{workSts1} or work_sts = #{workSts2} or work_sts = #{workSts3})
			</otherwise>
		</choose>
		AND item.item_num LIKE CONCAT('%' , #{itemNum}, '%')
	</sql>
	
	<sql id="SearchCount">
		SELECT COUNT(*)as count, work.work_num as workNum, clnt.clnt_nm as clientName, omng.ord_num as orderNum, 
			   work.work_dt as workDate, work.work_sts as workSts,
          	   item.item_num as itemNum, item.item_nm as itemName, item.invnt_unit as itemUnit, 
          	   line.line_cd as lineCode, line.line_nm as lineName, line.pro_cd as proCode, 
          	   work.work_qty as workQty, work.insert_dt as insertDate, work.insert_id as insertId
		FROM work_instr work JOIN order_mng omng ON work.ord_id = omng.ord_id
		JOIN order_info oinfo ON work.ord_info_id = oinfo.ord_info_id
		JOIN item item ON item.item_id = oinfo.item_id
		JOIN client clnt ON clnt.clnt_id = omng.clnt_id
		JOIN line line ON work.line_id = line.line_id
	</sql>
	
	<select id="getLineList" resultMap="lineMap">
		SELECT line_id AS lineId,
			   line_nm AS lineName,
			   pro_cd AS proCode,
			   place AS linePlace,
			   use_yn AS useChoice
		FROM line
		WHERE line_nm LIKE CONCAT('%', #{lineName}, '%')
	</select>
	
	<!-- 작업지시 등록 -->
	<insert id="instrInsert">
		INSERT INTO work_instr (instr_id, work_num, insert_id, ord_id, ord_info_id, work_sts, item_id, line_id, work_qty, work_dt, insert_dt)
		VALUES (#{instrId}, #{workNum}, #{insertId}, #{ordId}, #{ordInfoId}, #{workSts}, #{itemId}, #{lineId}, #{workQty}, #{workDate}, #{insertDate})
	</insert>
	
	<!-- 작업지시 삭제 -->
	<delete id="instrDelete">
		DELETE FROM work_instr
		WHERE instr_id = #{instrId}
	</delete>

</mapper>